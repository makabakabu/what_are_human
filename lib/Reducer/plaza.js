Object.defineProperty(exports,"__esModule",{value:true});var _immutable=require('immutable');var _moment=require('moment');var _moment2=_interopRequireDefault(_moment);var _uuid=require('uuid');var _uuid2=_interopRequireDefault(_uuid);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true});}else{obj[key]=value;}return obj;}var plaza=function plaza(){var state=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var action=arguments[1];var plazaName=state.get('plazaName');var speechId=state.getIn([plazaName,'speechId']);switch(action.type){case'PLAZA_CHOOSE_PLACE':{state=state.set('plazaName',action.plazaName);var title={tiananmen:'天安门',freedom:'时代广场',france:'协和广场',russia:'红场',flyArea:'飞地微斯人'};state=state.set('title',title[action.plazaName]);return state.setIn([action.plazaName,'viewMode'],'main');}case'SPEECH_DISCUSS':state=state.setIn([plazaName,'viewMode'],'discuss');state=state.set('title',state.getIn([plazaName,'content',action.speechId,'title']));return state.setIn([plazaName,'speechId'],action.speechId);case'CREATE_SPEECH':state=state.set('title','创建演讲');return state.setIn([plazaName,'viewMode'],'createSpeech');case'PLAZA_CHANGE_DISCUSS_VISIBILITY':return state.setIn([plazaName,'content',speechId,'discuss','visibility'],action.visibility);case'PLAZA_DISCUSS_CHANGE_TEXT':return state.setIn([plazaName,'content',speechId,'discuss','location','text'],action.text);case'PLAZA_DICUSS_COMFIRM':{var location=state.getIn([plazaName,'content',speechId,'discuss','location']);var to=location.get('discussId')===''?state.getIn([plazaName,'content',speechId,'userName']):state.getIn([plazaName,'content',speechId,'discuss','content',location.get('time'),location.get('discussId'),'userName']);var lastTime=(0,_immutable.List)(state.getIn([plazaName,'content',speechId,'discuss','content']).keySeq()).last();var lastTimeArray=lastTime.split('-');if(Number((0,_moment2.default)().format('YYYYMMDD'))>Number(lastTimeArray[0])*10000+Number(lastTimeArray[1])*100+Number(lastTimeArray[2])){state=state.updateIn([plazaName,'content',speechId,'discuss','content'],function(content){return content.concat((0,_immutable.OrderedMap)(_defineProperty({},(0,_moment2.default)().format('YYYY-MM-DD'),(0,_immutable.OrderedMap)(_defineProperty({},(0,_uuid2.default)(),(0,_immutable.Map)({userName:action.userInfo.get('userName'),gender:action.userInfo.get('gender'),to:to,text:location.get('text'),time:(0,_moment2.default)().format('YYYY-MM-DD hh:mm')}))))));});}else{state=state.updateIn([plazaName,'content',speechId,'discuss','content',lastTime],function(content){return content.concat((0,_immutable.OrderedMap)(_defineProperty({},(0,_uuid2.default)(),(0,_immutable.Map)({userName:action.userInfo.get('userName'),gender:action.userInfo.get('gender'),to:to,text:location.get('text'),time:(0,_moment2.default)().format('YYYY-MM-DD hh:mm')}))));});}return state.setIn([plazaName,'content',speechId,'discuss','location'],(0,_immutable.Map)({text:'',time:'',discussId:''}));}case'PLAZA_DISCUSS_PRESS_DIALOG':if(state.getIn([plazaName,'content',speechId,'discuss','location','discussId'])===action.discussId){state=state.setIn([plazaName,'content',speechId,'discuss','location','discussId'],'');}else{state=state.setIn([plazaName,'content',speechId,'discuss','location','discussId'],action.discussId);}return state.setIn([plazaName,'content',speechId,'discuss','location','time'],action.time);case'PLAZA_CREATESPEECH_PROTOCOL':state=state.set('title','广场演讲发言公约');return state.setIn([plazaName,'createSpeech','viewMode'],'protocol');case'PLAZA_CREATESPEECH_CHANGE_TEXT':return state.setIn([plazaName,'createSpeech','text'],action.value);case'PLAZA_CREATESPEECH_CHANGE_TITLE':return state.setIn([plazaName,'createSpeech','title'],action.value);case'PLAZA_CREATESPEECH_COMFIRM':{var createSpeechId=(0,_uuid2.default)();state=state.setIn([plazaName,'content',createSpeechId],(0,_immutable.Map)({userName:'我就是扯淡',gender:'female',title:state.getIn([plazaName,'createSpeech','title']),text:state.getIn([plazaName,'createSpeech','text']),share:(0,_immutable.Map)({number:0}),collect:(0,_immutable.Map)({number:0}),discuss:(0,_immutable.Map)({visibility:false,location:{time:'',discussId:''},content:(0,_immutable.OrderedMap)({})})}));state=state.setIn([plazaName,'createSpeech','speechId'],createSpeechId);return state.setIn([plazaName,'viewMode'],'main');}case'PLAZA_CREATESPEECH_CANCEL':state=state.setIn([plazaName,'viewMode'],'main');state=state.setIn([plazaName,'createSpeech','title'],'');return state.setIn([plazaName,'createSpeech','text'],'');case'PLAZA_SPEECH_DELETE':return state.deleteIn([plazaName,'content',action.speechId]);case'PLAZA_SHARE_PRESS':return state.setIn([plazaName,'viewMode'],'share');case'PLAZA_MOST':{var content=state.getIn([plazaName,'content']);var mostSpeechId=void 0;switch(action.viewMode){case'回复最多':mostSpeechId=(0,_immutable.List)(content.keySeq()).maxBy(function(speechContentId){return content.getIn([speechContentId,'discuss','content']).reduce(function(sum,review){return sum+review.size;},0);});break;case'转发最多':mostSpeechId=(0,_immutable.List)(content.keySeq()).maxBy(function(speechContentId){return content.getIn([speechContentId,'share','number']);});break;case'收藏最多':mostSpeechId=(0,_immutable.List)(content.keySeq()).maxBy(function(speechContentId){return content.getIn([speechContentId,'collect','number']);});break;default:break;}state=state.setIn([plazaName,'viewMode'],'discuss');return state.setIn([plazaName,'speechId'],mostSpeechId);}default:return state;}};exports.default=plaza;